/**
 * Webkul Software.
 *
 * @category  Webkul
 * @package   Webkul_MultiWishlist
 * @author    Webkul
 * @copyright Copyright (c) Webkul Software Private Limited (https://webkul.com)
 * @license   https://store.webkul.com/license.html
 */
define(
    [
    "jquery",
    "dexie",
    "mage/template",
    "Magento_Ui/js/modal/modal",
    "db",
    'Magento_Ui/js/modal/alert',
    'mage/translate'
    ], function ($, Dexie, template, modal, db, alert) {
        "use strict";
        $.widget(
            "multiwishlist.guest_cms",  {
                options: {},
                _create: function () {
                    var self = this;
                    var productUrl = self.options.productUrl;  
                    var selector = '';
                    if (self.options.wishlistStatus) { 
                        $('.action.towishlist').css('display','none');
                        $('.action.towishlist').after('<a href="#" class="action wk-towishlist" title="Add to Wish List" data-action="add-to-wishlist1"> <span>Add to Wish List</span></a>');
                     }

                    $("a.towishlist").click(
                        function (event) {
                            event.preventDefault();
                        }
                    );

                    // define pop up modal
                    var options_ques = {
                        type: 'popup',
                        responsive: true,
                        innerScroll: true,
                        modalClass: 'wk-mw-add-to-wishlist',
                        title: $.mage.__('Add to Wish List'),
                        buttons: [
                        {
                            text: $.mage.__('Add to Wish List'),
                            class: 'action primary',
                            click: function () {
                                var count = 0;
                                        if($(".wk-wishlist-list input").length) {
                                            var wishlistName = $(".wk-wishlist-list input");
                                            $.each(wishlistName, function(key, val) {
                                                if(val.checked) {
                                                    count++;
                                                }
                                            })
                                            if (count) {
                                                saveWishlistItem();
                                            } else {
                                                alert({
                                                    title: $.mage.__("Alert Message"),
                                                    content: $.mage.__("Please select some wishlist")
                                                })
                                            }
                                        } else {
                                            alert({
                                                title: $.mage.__("Alert Message"),
                                                content: $.mage.__("Please add some wishlist")
                                            })
                                        }
                                $('#wk-multiwishlist').modal('closeModal');
                            } //handler on button click
                        }
                        ]
                    };
                    var popup = modal(options_ques, $('#wk-multiwishlist'));

                    //set wishlist name data
                    var wishlistNameDataPopUp = getwishlistNameData();
                    var wishlistArray = [];
                    function getwishlistNameData() 
                    {
                
                        db.wishlistName.each(
                            function (item, cursor) {
                                $('.wk-mw-list').append(
                                    '<li class="wk-wishlist-list"><input type="checkbox" name="wk_id"'+
                                    'value="'+item.id+'"/><label>'+
                                    item.wishlistName+'</label></li>'
                                );
                                wishlistArray.push(item.wishlistName);
                            }
                        );
                    }

                    $('.wk-towishlist').on(
                        'click', function (event) {
                            wishlistArray = [];
                            selector = $(this);
                            event.preventDefault();
                            $('.wk-mw-list').html('');
                            $(".wk_name").val('');
                            getwishlistNameData();
                            $('#wk-multiwishlist').modal('openModal');
                        }
                    );

                    function saveWishlistItem() 
                    {
                        var ids = [];
                        $.each(
                            $("input[name='wk_id']:checked"), function () {
                                ids.push($(this).val());
                            }
                        );
                        var name_ids=[];
                        $.each(
                            $("input[name='wk_name_id']:checked"), function () {
                                name_ids.push($(this).val());
                            }
                        );

                        // -----create wishlist name
                        var wishlistNameIds = ids;
                        db.transaction(
                            'rw', db.wishlistName, function () {
                                $.each(
                                    name_ids, function (index, value) {
                                        db.wishlistName.add(
                                            { // returns promise
                                                wishlistName: value
                                            }
                                        ).then(
                                            function (id) {
                                                // capture promise
                                                wishlistNameIds.push(id);
                                            }
                                        );
                                    }
                                );
                
                            }
                        ).then(
                            function () {
                                // --- save wishlist item
                                var productData = $(selector).siblings('.action.towishlist').data('post').data; 
                                $('div.table-wrapper.grouped  input').each(
                                    function () {
                                        var key1 = jQuery(this).attr('name');
                                        productData[key1] = jQuery(this).val(); 
                                    }
                                );
                                db.transaction(
                                    'rw', db.wishlistData, function () {
                                        $.each(
                                            wishlistNameIds, function (id, val) {
                                                db.wishlistData.add(
                                                    {
                                                        productId: parseInt(productData.product),
                                                        data: productData,
                                                        wishlistNameId: parseInt(val)
                                                    }
                                                );
                                            }
                                        );
                                        alert(
                                            {
                                                title: $.mage.__('Success!'),
                                                content: $.mage.__('Item added to Wishlist.'),
                                                actions: {
                                                    always: function (){}
                                                }
                                            }
                                        );
                                    }
                                ).catch(
                                    function (e) {
                                        console.error(e.stack);
                                    }
                                );
                            }
                        ).catch(
                            function (e) {
                                    console.error(e.stack);
                            }
                        );
                    }
                    var currentWishlistArray =[];
                    $(document).on(
                        'click','.wk-modal-button',function () {
                            var temp = $(".wk_name").val();
                            var wk_name = unescapeHtml(temp);
                            $("#guestmsg").css("display","none");
                            for( var i=0; i<wishlistArray.length; i++) {
                                if(wishlistArray[i] == wk_name) {
                                    wk_name = '';
                                    $("#guestmsg").css("display","block");
                                }
                            }
                            for( var i=0; i<currentWishlistArray.length; i++) {
                                if(currentWishlistArray[i] == wk_name) {
                                    wk_name = '';
                                    $("#guestmsg").css("display","block");
                                }
                            }
                            currentWishlistArray.push(wk_name);
                            if(wk_name!='' && wk_name!='null') {
                                $('.wk-mw-list').append(
                                    '<li class="wk-wishlist-list wk-added"><input type="checkbox" name="wk_name_id"'+
                                    'value="'+wk_name+'"/><label>'+
                                    wk_name+'</label></li>'
                                );
                                $(".wk_name").val('');
                            }
                        }
                    );

                    function escapeHtml(str) 
                    {
                        var div = document.createElement('div');
                        div.appendChild(document.createTextNode(str));
                        return div.innerHTML;
                    }

                    function unescapeHtml(escapedStr) 
                    {
                        var div = document.createElement('div');
                        div.innerHTML = escapedStr;
                        var child = div.childNodes[0];
                        return escapeHtml(child ? child.nodeValue : '');
                    }
                },
            }
        );
        return $.multiwishlist.guest_cms;
    }
);